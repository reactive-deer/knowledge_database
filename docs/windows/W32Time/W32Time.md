#### W32Time

---

Операционные системы семейства **Windows** содержат службу времени **W32Time**. Эта служба предназначена для синхронизации времени в пределах организации. W32Time отвечает за работу как клиентской, так и серверной части службы времени, причем один и тот же компьютер может быть одновременно и клиентом и сервером NTP (NTP - Network Time Protocol).



**По умолчанию служба времени в Windows сконфигурирована следующим образом:**

* **При установке операционной системы** Windows запускает клиента NTP, который синхронизируется с внешним источником времени;

* **При добавлении компьютера в домен** тип синхронизации меняется. Все клиентские компьютеры и рядовые сервера в домене используют для синхронизации времени контроллер домена, проверяющий их подлинность;

* **При повышении рядового сервера до контроллера домена** на нем запускается NTP-сервер, который в качестве источника времени использует контроллер с ролью PDC-эмулятор;

* **PDC-эмулятор**, расположенный в корневом домене леса, является основным сервером времени для всей организации. При этом сам он также синхронизируется с внешним источником времени.





#### Настройка

Можно получить доступ к параметрам сервиса через реестр - **HKEY_LOCAL_MACHINE\ System\ CurrentControlSet\ services\ W32Time**



1. Включить сервис можно по пути - **...\W32Time\TimeProviders\NtpServer** через параметр **"Enabled"**

2. Затем следует перезапустить сервис для применения настроек

   ```
   #cmd
   net stop w32time
   net start w32time
   ```

3. Основная конфигурация сервера производится по пути - **...\W32Time\Parameters**.

   * **Type** - тип синхронизации

     Возможные значения:

     * `NoSync` - NTP-сервер не синхронизируется с каким либо внешним источником времени. Используются системные часы, встроенные в микросхему CMOS самого сервера (в свою очередь эти часы могут синхронизироваться от источника NMEA по RS-232 например);
     * `NTP` — NTP-сервер синхронизируется с внешними серверами времени, которые указаны в параметре реестра NtpServer;
     * `NT5DS` —  NTP-сервер производит синхронизацию согласно доменной иерархии;
     * `AllSync` - NTP-сервер использует для синхронизации все доступные источники.

     **Значение по умолчанию** для компьютера, **входящего в домен — NT5DS**, для **отдельно стоящего компьютера —  NTP**.

     

   * **NtpServer** - указываются NTP-сервера, с которыми будет синхронизировать время данный сервер. Указывать новые сервера можно введя их DNS имена или IP адреса через пробел. В конце каждого имени можно добавлять **флаг** (напр. ,0×1) который определяет режим для синхронизации с сервером времени. 

     Допускаются следующие значения режима:

     * `0×1` – SpecialInterval, использование временного интервала опроса;
     * `0×2` – режим UseAsFallbackOnly;
     * `0×4` – SymmetricActive, симметричный активный режим;
     * `0×8` – Client, отправка запроса в клиентском режиме.

     

   * **AnnounceFlags** - Он отвечает за то, как о себе заявляет NTP-сервер

     Чтобы заявить рядовой сервер (не домен-контроллер) как надежный источник времени, нужен флаг 5.

     

   * **SpecialPollInterval** - время обновления

     Путь - **...\W32Time\TimeProviders\NtpClient**

     Он задается в секундах и по умолчанию его значение равно **604800**, что составляет 1 неделю. Это очень много, поэтому стоит уменьшить значение SpecialPollInterval до разумного значения - **1 часа (3600)**.









#### Команды

* `w32tm /query /configuration` - вывод всех параметров сервера
* `w32tm /config /update` - обновление конфигурации после настройки
* `w32tm /monitor` - отображение состояния синхронизации контроллеров домена в домене
  * `w32tm /monitor /computers:200.100.100.100` - различия во времени сервера и удаленного компьютера
* `w32tm /resync` - принудительная синхронизация
* `w32tm /stripchart` - показывает разницу во времени между текущим и удаленным компьютером
  * `w32tm /stripchart /computer:200.100.100.100 /samples:5 /dataonly` - произведет 5 сравнений с указанным источником и выдаст результат в текстовом виде
* `w32tm /config` - это основная команда, используемая для настройки службы NTP. С ее помощью можно задать список используемых серверов времени, тип синхронизации и многое другое.
* `w32tm /query` - показывает текущие настройки службы
  * `w32tm /query /source` - покажет текущий источник времени
  * `w32tm /query /peers` - отображение текущих источников синхронизации и их статуса



* `net stop w32time` && `net start w32time` - выключение и запуск службы



* `netdom query fsmo` - проверка параметров, среди которых есть NTP сервер, к которому обращается текущая машина.





#### Источники

* http://skylarkrussia.tv/support/ntp_server_activation/
* http://pyatilistnik.org/kak-nastroit-ntp-server-i-sinhronizatsiyu-vremeni-v-domene-active-directory/