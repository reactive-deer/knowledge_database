# Apache

**Apache** - популярный бесплатный opensource веб-сервер. Он является частью стека **LAMP** (Linux, Apache, MySQL, PHP), который обеспечивает большую часть Интернета.



## Установка

CentOS: `dnf update && dnf –y install httpd`

Debian: `apt update && apt –y install apache2`



## Файлы

### Файлы конфигураций

- `/etc/httpd/` - Расположение всех файлов конфигурации
- `/etc/httpd/conf/httpd.conf` - основной файл конфигурации Apache
- `/etc/httpd/conf.d/` - Все конфигурационные файлы в этом каталоге включены в основной файл настроек
- `/etc/httpd/conf.modules.d/` - Расположение конфигурационных файлов модуля Apache

> Примечание. При внесении изменений в файлы конфигурации не забывайте всегда перезапускать службу Apache, чтобы применить новую конфигурацию.



### Логи

* `/var/log/httpd/` - расположение файлов логов Apache

- `/var/log/httpd/access_log` - показывает журнал систем, которые обращались к серверу
- `var/log/httpd/error_log` - показывает список любых ошибок, с которыми сталкивается Apache



### Типичные места для хранения сайтов

* `/home/username/my_website`
* `/var/www/my_website`
* `/var/www/html/my_website`
* `/opt/my_website`



### Документация

* `/usr/share/doc/httpd`





## Управление

```
systemctl [start/stop] [status] [enable/disable] [restart/reload] httpd/apache2
```

* `reload` - перечитывание конфигурации
* `restart` - перезапуск сервиса



### apachectl

[**apachectl**](http://httpd.apache.org/docs/2.4/programs/apachectl.html) - интерфейс управления HTTP-сервером Apache

- `start`

  Запускает`httpd` демон **Apache** . Выдает ошибку, если он уже запущен. Это эквивалентно `apachectl -k start`.

- `stop`

  Останавливает `httpd` демон **Apache** . Это эквивалентно `apachectl -k stop`.

- `restart`

  Перезапускает `httpd` демон **Apache** . Если демон не запущен, он запускается. Эта команда автоматически проверяет файлы конфигурации `configtest` перед началом перезапуска, чтобы убедиться, что демон не умер. Это эквивалентно `apachectl -k restart`.

- `fullstatus`

  Отображает полный отчет о состоянии из `mod_status`. Чтобы это работало, вам необходимо иметь включенным на своем сервере`mod_status`  и текстовый браузер, например, `lynx` доступный в вашей системе. URL-адрес, используемый для доступа к отчету о состоянии, можно установить, отредактировав `STATUSURL`переменную в скрипте.

- `status`

  Отображает краткий отчет о состоянии. Аналогично этой `fullstatus`опции, за исключением того, что список обслуживаемых в данный момент запросов опущен.

- `graceful`

  Изящно перезапускает `httpd` демон **Apache** . Если демон не запущен, он запускается. Это отличается от обычного перезапуска тем, что открытые в данный момент соединения не прерываются. Побочным эффектом является то, что старые файлы журналов не закрываются немедленно. Это означает, что при использовании в сценарии ротации журналов может потребоваться значительная задержка, чтобы гарантировать закрытие старых файлов журналов перед их обработкой. Эта команда автоматически проверяет файлы конфигурации `configtest `перед запуском перезапуска, чтобы убедиться, что **Apache** не умирает. Это эквивалентно `apachectl -k graceful`.

- `graceful-stop`

  Изящно останавливает `httpd `демон **Apache** . Это отличается от обычной остановки тем, что открытые в данный момент соединения не прерываются. Побочным эффектом является то, что старые файлы журналов не закрываются немедленно. Это эквивалентно `apachectl -k graceful-stop`.

- `configtest`

  Запустите проверку синтаксиса файла конфигурации. Он анализирует файлы конфигурации и сообщает `Syntax Ok` либо подробную информацию о конкретной синтаксической ошибке. Это эквивалентно `apachectl -t`.





## Конфигурация

Сервер настраивается путём размещения [директив конфигурации](http://httpd.apache.org/docs/2.4/mod/quickreference.html) в этих файлах конфигурации. **Директива** — это ключевое слово с одним или несколькими аргументами, устанавливающими её значение.

`директива {аргумент} {аргумент\ через\ пробелы}`

На вопрос: «*Где я должен прописать эту директиву?*» – обычно отвечают, там где ты хочешь использовать её. Если это глобальная настройка, она должна располагаться в конфигурационном файле вне разделов `<Directory>`, `<Location>`, `<VirtualHost>` или других разделов. Если настройка относится только к конкретному каталогу, значит она должна быть внутри секции `<Directory>`, которая описывает этот каталог, и так далее. Смотри документ [Разделы конфигурации](http://httpd.apache.org/docs/2.4/sections.html) с подробным описанием вышеуказанных разделов.



### httpd.conf

> **Совет:** Вы можете проверить корректность настроек Apache без запуска сервера командой `apachectl configtest`.

**Директивы:**

* `User http`

  По соображениям безопасности при запуске сервера Apache от имени суперпользователя (напрямую или через скрипт инициализации) происходит смена идентификатора пользователя (UID), от имени которого выполняется процесс сервера. По умолчанию используется пользователь `http`, который не имеет привилегированных полномочий в системе.

* `Listen 80` | [Документация](http://httpd.apache.org/docs/2.4/bind.html)

  Это порт, через который Apache принимает входящие соединения. Если сервер имеет выход в интернет через маршрутизатор, необходимо будет настроить перенаправление этого порта.
  Если вы используете Apache для разработки и тестирования, вы можете разрешить только локальный доступ к нему. Для этого укажите `Listen 127.0.0.1:80.`

* `ServerAdmin you@example.com`

  Адрес электронной почты администратора, который будет выводиться, например, на странице ошибки **Apache**.

* `DocumentRoot "/srv/http"`

  Это корневая директория **Apache**, в которой можно разместить ваши веб-страницы.
  Измените ее, если нужно, но не забудьте также поменять путь в директиве `<Directory "/srv/http">` на новое расположение `DocumentRoot`, иначе вы, скорее всего, получите сообщение об ошибке 403 Error (недостаточно полномочий) при попытке получить доступ к новому корневому каталогу Apache. Также не забудьте изменить строку `Require all denied` на `Require all granted`, иначе снова получите ошибку 403 Error. Помните, что директория DocumentRoot и ее родительские папки должны иметь разрешения на запуск для всех (можно установить командой `chmod o+x /path/to/DocumentRoot>)`, в противном случае вы получите ошибку **403 Error**.

  Обычно, когда запрашивается каталог, без указания имени файла, то будет отдан документ с именем `index.html`. Например, если для директивы `DocumentRoot` установлено значение `/var/www/html` и приходит запрос на адрес `http://www.example.com/work/`, то файл расположенный по пути `/var/www/html/work/index.html` будет отдан клиенту.

* `AllowOverride None`

  Запрещает переопределение настроек. Если в секции `<Directory>` указана эта директива, Apache будет полностью игнорировать настройки в файле `.htaccess`. Обратите внимание, что теперь такая настройка для Apache 2.4 является настройкой по умолчанию, поэтому если вы планируете использовать `.htaccess`, вам необходимо дать соответствующие разрешения. 

  Если вы собираетесь включить модуль `mod_rewrite` или использовать настройки в `.htaccess`, вы можете определить какие из директив, объявленных в этих файлах, могут перезаписывать конфигурацию сервера. Для получения дополнительной информации обратитесь к [документации Apache](http://httpd.apache.org/docs/current/mod/core.html#allowoverride).





## Виртуальные хосты (VirtualHost)

Термин виртуальный хост относится к практике запуска более одного веб-сайта (например, `company1.example.com`и `company2.example.com`) на одной машине. Виртуальные хосты могут быть "[IP-based](http://httpd.apache.org/docs/2.4/vhosts/ip-based.html)", что означает, что у вас есть разные IP-адреса для каждого веб-сайта, или "[name-based](http://httpd.apache.org/docs/2.4/vhosts/name-based.html)", что означает, что у вас есть несколько имен, работающих на каждом IP-адресе. Тот факт, что они работают на одном физическом сервере, не очевиден для конечного пользователя.

[Примеры конфигураций](http://httpd.apache.org/docs/2.4/vhosts/examples.html)

Apache был одним из первых серверов, который прямо из коробки поддерживал виртуальные хосты на основе IP. Версии 1.1 и более поздние версии Apache поддерживают виртуальные хосты на основе IP и имен (vhosts). Последний вариант виртуальных хостов иногда также называют виртуальными хостами на *основе хоста* или *без IP* .



## Reverse-proxy

http://httpd.apache.org/docs/2.4/howto/reverse_proxy.html





## Перенаправление HTTP на HTTPS

https://www.dmosk.ru/miniinstruktions.php?mini=apache-ssl



## Инструкция

1. Установить **Apache**

   ```
   dnf install httpd
   apt install apache2
   ```

2. Запустить и добавить его в автозагрузку

   ```
   systemctl start httpd
   systemctl enable httpd
   ```

3. Добавить исключение в файервол (**http** - *80 port*: **https** - *443 port*)

4. Создать директорию для нового сайта с каталогами **html** (файлы сайта) и **log** (для хранения журналов)

   ```
   mkdir -p /var/www/www.skill39.wsr/html
   mkdir /var/www/www.skill39.wsr/log
   ```

5. Назначить права доступа для пользователя указанного либо глобально в файле *httpd.conf* (**apache**/**apache**) или для кастомного пользователя, объявленного в конфигурации опредленного *виртуального хоста*

   ```bash
   chown -R [user]:[group] /var/www/www.skill39.wsr/html
   ```

6. Убедитесь, что ваша корневая директория имеет набор разрешений по умолчанию:

   ```bash
   chmod -R 755 /var/www
   ```

7. Создать файл `index.html` (данная страница будет показывать по умолчанию при входе на сайт)

   ```
   nano /var/www/www.skill39.wsr/html/index.html
   
   <html>
     <head>
       <title>Welcome to WSR!</title>
     </head>
     <body>
       <h1>Success! The www.skill39.wsr virtual host is working!</h1>
     </body>
   </html>
   ```

8. Затем необходимо создать директории `sites-available` (конфигурации виртуальных хостов) и `sites-enabled` (символьные ссылки на конфигурации виртуальных хостов, которые готовы к обслуживанию)

   ```
   cd /etc/httpd/
   mkdir sites-available sites-enabled
   ```

9. Указать глобально, что поиск хостов будет выполняться в директории `sites-enabled`

   ```
   nano conf/httpd.conf
   
   IncludeOptional sites-enabled/*.conf
   ```

10. Теперь можно создать новый виртуальный хост. Шаблон можно найти в директории `/usr/share/doc/httpd/`

    ```
    cd /usr/share/doc/httpd/
    cp httpd-vhost.conf /etc/httpd/site-available/www.skill39.wsr.conf
    ```

11. Редактирование файла конфигурации виртуального хоста

    ```shell
    nano /etc/httpd/site-available/www.skill39.wsr.conf
    
    <VirtualHost *:80>	#Виртуальный хост доступный при запросе на любой адрес серваера и 80 порт
        ServerName www.skill39.wsr	# Имя, которое будет сравниваться, если несколько хостов будет иметь одинаковые настройки
        ServerAlias skill39.wsr		# Другие имена, по котором будет доступен данный хост
        DocumentRoot /var/www/www.skill39.wsr/html		# Точка начала сайта
        ErrorLog /var/www/www.skill39.wsr/log/error.log		# Журнал ошибок
        CustomLog /var/www/www.skill39.wsr/log/requests.log combined	# Журнал запросов
    </VirtualHost>
    ```

12. Создать символьную ссылку (**абсолютный путь**) в директорию `sites-enabled`, чтобы показать, что хост готов к работе

    ```bash
    ln -s /etc/httpd/sites-available/www.skill39.wsr.conf /etc/httpd/sites-enabled/www.skill39.wsr.conf
    ```
    
13. Перезагрузить сервер

    ```bash
    systemctl restart httpd
    ```

    



# Источники

https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-centos-7-ru

http://httpd.apache.org/

http://httpd.apache.org/docs/2.4/

http://httpd.apache.org/docs/2.4/configuring.html

http://httpd.apache.org/docs/2.4/sections.html

https://wiki.archlinux.org/index.php/Apache_HTTP_Server_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)

https://unixhost.pro/clientarea/knowledgebase/12/ustanovka-i-nastroika-apache-php-mysql-na-centos.html

https://www.digitalocean.com/community/tutorials/apache-ubuntu-14-04-lts-ru