### logrotate

---

**logrotate** - утилита для архивации log-файлов. Осуществляет автоматическую архивацию (ротацию) log-файлов.



В планировщике задач (**cron**) ежедневно выполняется запуск *logrotate*

```
/usr/sbin/logrotate /etc/logrotate.conf
```

с указанием файла конфига

В конфиге настраиваются глобальные параметры, которые будут применяться по умолчанию, и как правило подключается директория

```
include /etc/logrotate.d
```

откуда будут подгружатся файлы с описанием правил (секции) для конкретных лог файлов.

> При ротации логов - текущий log-файл с которым работает программа - удаляется или перемещается, поэтому после ротации лога, будет правильным перезапустить программу/сервис, чей log-файл был удален. Нужно это, что бы программе был сообщен новый дискриптор файла. Хотя это ситуация может разрулится автоматически и без перезагрузки - если такую ситуацию предусмотрели разработчики.



#### Связанные файлы

* **/etc/logrotate.conf** - файл хранящий общие настройки ротации (для всех приложений и служб которые не обрабаываются отдельно)
* **/etc/logrotate.d** - директория хранящая конфигурационные файлы с настройками для отдельных лог-файлов



#### Параметры запуска утилиты

| Параметр                          | Описание                                                     |
| :-------------------------------- | :----------------------------------------------------------- |
| **-d**                            | debug - отладочный режим. В режиме отладки не будут производиться изменения в log-файле и файле состояния |
| **-f --force**                    | Принудительно произвести ротацию, даже если в данный момент она не требуется |
| **-m <команда> --mail <команда>** | Указать команду для отправки почты. Команда должна принимать два аргумента: тема сообщения и адрес получателя. Текст письма передается стандартным вводом (stdin). По умолчанию */usr/bin/mail -s* |
| **-s <файл> --state <файл>**      | Указать куда записать файл состояния. Что - то типа лога, показывает последнюю дату когда производилась ротация (если создания архива не требуется правилами, то дата все ровно обновляется) По умолчанию */var/lib/logrotate/status* |



#### Параметры файлов конфигурации

Ротацию можно производить по расписанию (ежедневно, еженедельно …) или по достижению определенного размера log-файлом - это взаимоисключающие параметры.

| Параметр                                                    | Описание                                                     |
| ----------------------------------------------------------- | ------------------------------------------------------------ |
| **rotate** <число>                                          | Количество хранимых файлов                                   |
| **daily** , **weekly**  , **monthly**                       | Производить ротацию раз в день, неделю, месяц. Несовместимость: *size* |
| **size <байт>** *size 1000 , size 100k , size 1M*           | Производить ротацию если log-файл превысил указанный размер. Несовместимость: *daily, weekly, monthly* |
| **start <число>**                                           | число с которого начнётся нумерация файлов                   |
| **compress**                                                | Архивировать файлы (по умолчанию gzip)                       |
| **nocompress**                                              | Отключает: *compress*                                        |
| **delaycompress**                                           | Не сжимать 'свеже' созданный архив. Например access.log.1 не будет cжат. Зависимость: *compress* **Несовместимость:** *nocompress* |
| **create <права><владелец><группа>** *create 640 root root* | После ротации создать пустой log-файл. Любые из этих атрибутов могут быть опущены, в этом случае вместо них для нового файла будут использованы атрибуты, имеющие те же значения, что и первоначальный log-файл |
| **nocreate**                                                | Не создавать пустой файл после ротации. **Отключает:** *create* |
| **copy**                                                    | Создать копию оригинального log-файла, не изменяя его. **Несовместимость:** *create* |
| **nocopy**                                                  | **Отключает:** *copy*                                        |
| **copytruncate**                                            | Создать копию оригинального log-файла, а потом его 'обнулить'. Таким образом сам файл ***не\*** удаляется и не меняется его дескриптор. **Несовместимость:** *create* |
| **ifempty**                                                 | Архивирует даже пустой файл (используется по умолчанию)      |
| **notifempty**                                              | Не архивировать пустые файлы. Отключает: *ifempty* **Несовместимость:** *size* |
| **missingok**                                               | В случае отсутствия оригинального log-файла не вызовет ошибку |
| **nomissingok**                                             | В случае отсутствия оригинального log-файла вызовет ошибку. **Отключает:** *missingok* |
| **postrotate** *<команды>* **endscript**                    | Строки, находящиеся между *postrotate* и *endscript* будут выполнены как sh скрипт после архивирования log-файла |
| **prerotate** *<команды>* **endscript**                     | Аналогично *postrotate*, только действия будут выполнены до начала архивирования |
| **sharedscripts**                                           | Скрипты *postrotate* и *prerotate* будут выполнены только один раз в рамках своей секции. |
| **nosharedscripts**                                         | **Отключает** *sharedscripts*. Скрипты будут выполняются при ротации *каждого* log-файла, при определение */var/log/apache2/\*.log* скрипт будет выполнен столько раз сколько уникальных log-файлов будет находится в данной директории |
| **olddir** <путь>                                           | Перемещать архивные файлы в указанную директорию             |
| **noolddir**                                                | Отключает *olddir*                                           |
| **dateext**                                                 | К имени файлов журналов добавляется дата (%Y%m%d), вместо номера |
| **su** <user> <group>                                       | Выполняется с правами указанного пользователя. Необходимо если ошибка: "because parent directory has insecure permissions", т.е. на директорию с логами, есть право на запись кроме root'a |
| **mail** <mail@domain.com>                                  | Отправляет ротированные логи на почту. Локально должна быть настроена MTA sendmail или т.п. |
| **nomail**                                                  | Отключает *mail*                                             |



#### Настройка

* Общее поведение **logrotate** настраивается в файле **logrotate.conf**

  ```
  # see "man logrotate" for details
  # rotate log files weekly
  weekly
  
  # keep 4 weeks worth of backlogs
  rotate 4
  
  # create new (empty) log files after rotating old ones
  create
  
  # use date as a suffix of the rotated file
  #dateext
  
  # uncomment this if you want your log files compressed
  #compress
  
  # packages drop log rotation information into this directory
  include /etc/logrotate.d
  ```

* Если необходимо обрабатывать логи какого-то приложения или службы с отличными от общих параметрами, то для этого создается конфигурационный файл в директории **/etc/logrotate.d/**.

  Пример конфигурации для обработки логов **apt**:

  ```
  /var/log/apt/term.log {
    rotate 12
    monthly
    compress
    missingok
    notifempty
  }
  
  /var/log/apt/history.log {
    rotate 12
    monthly
    compress
    missingok
    notifempty
  }
  ```

  В каждом индивидуальном файле открывается блок с именем файла логов (с путем) и фигурными скобками.

  В фигурных скобках вкладываются параметры подходящие под задачу и с необходимыми значениями.







Источники:

* https://wiki.enchtex.info/tools/system/logrotate
* https://www.opennet.ru/man.shtml?topic=logrotate
* https://www.opennet.ru/base/sys/logrotate_howto.txt.html

